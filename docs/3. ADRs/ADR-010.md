# ADR 010 – Estratégia de Cache para API de Centros de Distribuição

Data: 21/09/2025  
Autor: Ciro Rezende <cirorezende@gmail.com>

**Item:** Mecanismo de cache para otimizar chamadas à API externa de consulta de CDs por item.

**Decisão a ser tomada:** Definir a estratégia de cache para reduzir chamadas repetidas à API externa e melhorar performance do sistema, considerando que a API só aceita chamadas unitárias.

**Possibilidades levantadas:**  

- **Cache em memória local (ex.: EHCache):** Rápido, mas limitado ao escopo da aplicação e perdido em reinicializações, além de trazer grandes riscos de estouro de memória.
- **Cache distribuído (Redis):** Compartilhado entre instâncias, persistente, mas com latência de rede.
- **Cache híbrido (L1 + L2):** Combinação de cache local e distribuído para otimizar performance e consistência.
- **Sem cache:** Sempre consultar a API externa, garantindo dados sempre atualizados.

**Escolha:** Cache distribuído (Redis).

**Justificativa:**  
Para a primeira versão do sistema, o cache distribuído com Redis oferece o melhor equilíbrio entre simplicidade e eficácia:

**Configuração do Cache Redis:**
- TTL: 8 horas (renovado diariamente às 00:00)
- Chave: `cd_cache:item:{itemId}`
- Valor: Lista de CDs em formato JSON
- Evicção: TTL automático + limpeza diária programada

**Benefícios da abordagem:**
1. **Simplicidade operacional:** Uma única camada de cache reduz a complexidade de implementação e manutenção
2. **Consistência entre instâncias:** Todas as instâncias da aplicação compartilham o mesmo cache, evitando inconsistências e trazendo o benefício a todas as intâncias.
3. **Persistência:** Cache não afetado pela reinicializações da aplicação, mantendo a performance
4. **Escalabilidade:** Redis suporta facilmente o crescimento do número de instâncias da aplicação
5. **Observabilidade:** Métricas centralizadas de hit/miss ratio e performance do cache
6. **Gestão de memória:** Controle centralizado do uso de memória, evitando problemas de OutOfMemory nas instâncias da aplicação

**Operação:**
- Cache miss: Consulta API externa → Armazena resultado no Redis → Retorna para aplicação
- Cache hit: Retorna diretamente do Redis sem consultar API externa
- Invalidação: Limpeza automática diária às 00:00 conforme assumido na arquitetura

Esta abordagem reduz significativamente as chamadas à API externa enquanto mantém a simplicidade necessária para a primeira versão do sistema.