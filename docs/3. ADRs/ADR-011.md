# ADR 011 – Estratégia de Tratamento de Erros e Resiliência

Data: 21/09/2025  
Autor: Ciro Rezende <cirorezende@gmail.com>

**Item:** Mecanismos de tratamento de falhas na integração com API externa e processamento de pedidos.

**Decisão a ser tomada:** Definir como o sistema deve se comportar em cenários de falha da API de CDs, timeouts, indisponibilidades e outros erros durante o processamento de pedidos.

**Possibilidades levantadas:**  

- **Falha rápida (fail-fast):** Rejeitar pedido imediatamente em caso de qualquer falha.
- **Retry simples:** Tentar novamente um número fixo de vezes.
- **Retry com backoff exponencial:** Aumentar progressivamente o intervalo entre tentativas.
- **Circuit breaker:** Interromper chamadas quando a API externa está instável.
- **Processamento assíncrono com retry:** Processar pedidos em background com múltiplas tentativas.

**Escolha:** Combinação de retry com backoff exponencial + circuit breaker + processamento assíncrono.

**Justificativa:**  
Esta abordagem garante máxima resiliência e experiência do usuário:

**Retry com Backoff Exponencial:**
- Máximo 3 tentativas por item
- Intervalo inicial: 1 segundo
- Multiplicador: 2x (1s, 2s, 4s)

**Circuit Breaker:**
- Threshold: 50% de falhas em 10 chamadas consecutivas
- Timeout: 30 segundos em estado aberto
- Half-open: 3 chamadas de teste antes de fechar

**Processamento Assíncrono:**
- Pedidos aceitos imediatamente com status "PROCESSING"
- Processamento em background via tópicos Kafka
- Notificação de conclusão via eventos Kafka

**Fallback Strategy:**
- Se API de CDs falhar para um item após todas as tentativas, usar CD padrão baseado na região do cliente
- Registrar falha para análise posterior
- Continuar processamento dos demais itens do pedido